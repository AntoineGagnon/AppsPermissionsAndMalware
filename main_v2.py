"""
Created by: Antoine Gagnon
"""

import app_data, observatory_data


def main(args):
    if not args.no_load_db:
        if args.filename:
            load_apps_data(args.filename)
        else:
            files = os.listdir("split_files")

            print("Loading database app info")
            for csv_file in files:
                load_apps_data(csv_file)

    db_apps_packages = App.select().order_by(App.id)
    thread_list = []
    print("Analyzing APKs")
    for app in tqdm(db_apps_packages):
        apk_path = permissions_analysis(app)
        if app.dl_available == 1:
            if (len(thread_list) == 5):
                for thread in thread_list:
                    thread.join()
                thread_list = []

            if len(thread_list) < 5:
                thread = threading.Thread(target=virus_analysis, args=(app,))
                thread_list.append(thread)
                thread.start()

        # if apk_path and os.path.exists(apk_path):
        #    os.remove(apk_path)