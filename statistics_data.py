"""
Created by: 

"""
from scipy.stats import spearmanr, mannwhitneyu, kstest
from tqdm import tqdm

from main import AVReport, App, Permission, AccessPermission


def get_rating_stats():
    checked_apps = AVReport.select(AVReport.app)

    all_apps = App.select().where(App.virus_total_resource.is_null(False)).where(App.category != "Unknown").where(
        App.id.in_(checked_apps))
    ratings = []
    risk_scores = []
    mannu_risk_scores = []
    for app in tqdm(all_apps):
        av_report = app.avreport.get()
        risk_score = av_report.number_warning / av_report.total_number
        risk_scores.append(risk_score)
        if (risk_score > 0):
            mannu_risk_scores.append(1)
        else:
            mannu_risk_scores.append(0)
        ratings.append(app.rating)

    spearman_results = spearmanr(ratings, risk_scores)

    print(spearman_results)

    mannwhitneyu_results = mannwhitneyu(ratings, mannu_risk_scores)

    print(mannwhitneyu_results)


def get_price_stats():
    checked_apps = AVReport.select(AVReport.app)

    all_apps = App.select().where(App.virus_total_resource.is_null(False)).where(App.category != "Unknown").where(
        App.id.in_(checked_apps))
    prices = []
    risk_scores = []
    mannu_risk_scores = []
    for app in tqdm(all_apps):
        av_report = app.avreport.get()
        risk_score = av_report.number_warning / av_report.total_number
        risk_scores.append(risk_score)
        if (risk_score > 0):
            mannu_risk_scores.append(1)
        else:
            mannu_risk_scores.append(0)
        prices.append(app.price)

    spearman_results = spearmanr(prices, risk_scores)

    print(spearman_results)

    mannwhitneyu_results = mannwhitneyu(prices, mannu_risk_scores)

    print(mannwhitneyu_results)


def dangerous_perm_risk_score_correl():
    checked_apps = AVReport.select(AVReport.app)

    all_apps = App.select().where(App.virus_total_resource.is_null(False)).where(App.id.in_(checked_apps))
    dangerous_perm_count = []
    risk_scores = []
    mannu_risk_scores = []
    dangerous_permissions = Permission.select().where(Permission.protection_level == "dangerous")
    for app in tqdm(all_apps):
        count_perm_dangereuses = AccessPermission.select().where(AccessPermission.app == app).where(
            AccessPermission.permission.in_(dangerous_permissions)).count()
        risk_score = app.avreport.get().number_warning / app.avreport.get().total_number
        if (risk_score > 0):
            mannu_risk_scores.append(1)
        else:
            mannu_risk_scores.append(0)
        risk_scores.append(risk_score)
        dangerous_perm_count.append(count_perm_dangereuses)

    kscore_avscore = kstest(risk_scores, 'norm')

    kscore_perm_dangereuses = kstest(dangerous_perm_count, 'norm')

    print(kscore_avscore)
    print(kscore_perm_dangereuses)

    spearman_results = spearmanr(risk_scores, dangerous_perm_count)

    print(spearman_results)

    mannwhitneyu_results = mannwhitneyu(mannu_risk_scores, dangerous_perm_count)

    print(mannwhitneyu_results)

dangerous_perm_risk_score_correl()
