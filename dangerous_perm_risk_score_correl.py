"""
Created by: 

"""
import scipy
from scipy.stats import kstest, spearmanr
from tqdm import tqdm

from main import AVReport, App, Permission

checked_apps = AVReport.select(AVReport.app)

all_apps = App.select().where(App.virus_total_resource.is_null(False)).where(App.id.in_(checked_apps))
app_perm_dangereuses_count = []
av_scores = []
for app in tqdm(all_apps):
    count_perm_dangereuses = 0
    for access_permissions in app.permissions:
        perm = Permission.get(Permission.id == access_permissions.permission)
        if(perm.protection_level == "dangerous"):
            count_perm_dangereuses += 1
    av_score = app.avreport.get().number_warning / app.avreport.get().total_number
    av_scores.append(av_score)
    app_perm_dangereuses_count.append(count_perm_dangereuses)

kscore_avscore = kstest(av_scores, 'norm')

kscore_perm_dangereuses = kstest(app_perm_dangereuses_count,'norm')

print(kscore_avscore.statistic)
print(kscore_perm_dangereuses)

result = spearmanr(av_scores, app_perm_dangereuses_count)

print(result)