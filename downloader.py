import os

import requests
from bs4 import BeautifulSoup
from lxml import html


def apk_mirror_dl(app_package):
    apk_mirror_search_url = 'https://www.apkmirror.com/?post_type=app_release&searchtype=apk&s='

    search_page = requests.get(apk_mirror_search_url + app_package)

    tree = html.fromstring(search_page.content)
    element = tree.xpath('//*[@id="content"]/div[2]/div[3]/div/div[4]/div/div[2]/a')


    address = element[0].attrib['href']

    if address:
        download_page_suffix = address.split('/')[-2].replace("release","android-apk-download/download/")
        download_page_address = 'https://www.apkmirror.com' + address + download_page_suffix

        download_page = requests.get(download_page_address)

        download_tree = html.fromstring(download_page.content)

        download_element = download_tree.xpath('//article/div[2]/div/div/div[1]/p[2]/span/a')

        download_link_suffix = download_element[0].attrib['href']

        download_link = 'https://www.apkmirror.com'  + download_link_suffix

        print(download_link)

        r = requests.get(download_link)


        f =  open('./apk/' + app_package + '.apk', 'wb')
        f.write(r.content)
        return os.path.abspath(f)


dl_address = apk_mirror_dl("com.microsoft.emmx")

print(dl_address)


